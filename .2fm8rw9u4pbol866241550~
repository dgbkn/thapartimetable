<?php
include('session.php');
?>


<?php include('conn.php');
$page_title = "Modify Contract";
include('header.php');
include('smsapi/smsapi.php');
// require 'smsapi/autoload.php';

// use SMSGatewayMe\Client\ApiClient;
// use SMSGatewayMe\Client\Configuration;
// use SMSGatewayMe\Client\Api\MessageApi;
// use SMSGatewayMe\Client\Model\SendMessageRequest;

?>

<?php
if(isset($_GET['id']) || isset($_GET['pid'])){

    $id = $_GET['id'];
 

if(isset($_GET['pid'])){
    $link = 'party_detail.php?id='.$_GET['pid'];
    // echo $link;
}elseif(!isset($_GET['pid'])){
    $link = 'contract_view.php';

}

    $oth_sql = "SELECT * FROM `r_contract` WHERE CONCAT(`r_contract`.`id`) = $id ";
    $oth_res = mysqli_query($conn,$oth_sql);
    $oth_rec = mysqli_fetch_assoc($oth_res);
    // $date = $oth_rec['date'];
    $s_party = $oth_rec['seller_party'];
    $b_party = $oth_rec['buyer_party'];
    $goods = $oth_rec['goods'];
    $rate = $oth_rec['RATE'];
    $quality = $oth_rec['quality'];
    $pay_con = $oth_rec['pay_con'];
    $s_brok = $oth_rec['sb'];
    $b_brok = $oth_rec['bb'];
    $deli_con = $oth_rec['del_con'];
    $dis_st_from = $oth_rec['dsf'];
    $unit = $oth_rec['r_unit'];
    $date = date('j F, Y', strtotime($oth_rec['date']));
    $quantity = $oth_rec['quantity'] ;

// echo $date;
// echo $s_party;

$date_new = $s_party_new = $b_party_new = $goods_new = $quantity_new = $rate_new = $deli_con_new = $quality_new = $dis_st_from_new =$unit_new= $pay_con_new =$s_brok_new=$b_brok_new= '';
$error = ['date_new' => '', 's_party_new' => '', 'b_party_new' => '', 'goods_new' => '', 'quantity_new' => '', 'rate_new' => '', 'deli_con_new' => '', 'quality_new' => '', 'dis_st_from_new' => '', 'pay_con_new' => '', 's_brok_new' => '', 'b_brok_new' => '','unit_new'=> '','sms' => ''];
$page_title = 'Modify Contract ';
$sql123 = "SELECT name FROM `ledgers`";
$result123 = mysqli_query($conn, $sql123);



if (isset($_GET['id'])) {
    $new_id = $_GET['id'];
} else {
    $new_id = 0;
}


$sql1234 = "SELECT name FROM `goods`";
$result1234 = mysqli_query($conn, $sql1234);
// echo $new_id;





$sql_g = "SELECT name FROM `ledgers` order by name asc";
$result_g = mysqli_query($conn, $sql_g);


$sql_g1 = "SELECT name FROM `ledgers` order by name asc";
$result_g1 = mysqli_query($conn, $sql_g1);






if (isset($_POST['submit'])) {
    // echo $_POST['group'];
    //true if form submitted
    if (empty($_POST['date_new'])) {
        $error['date_new'] = "Enter date_new";
          if($_POST['date_new']== 'dd/mm/yyyy'){
        $error['date_new'] = "Enter date";}
    } else {
        $date_new = $_POST['date_new'];
    }

    if (empty($_POST['s_party_new'])) {
        $error['s_party_new'] =  "Enter seller_party";
    } else {
        $s_party_new = $_POST['s_party_new'];
    }

    if (empty($_POST['b_party_new'])) {
        $error['b_party_new'] =  "Enter buyer_party";
    } else {
        $b_party_new = $_POST['b_party_new'];
    }


    if (empty($_POST['goods_new'])) {
        $error['goods_new'] =  "Enter goods_new";
    } else {
        $goods_new = $_POST['goods_new'];
    }
  

    
    if (empty($_POST['quantity_new'])) {
        $error['quantity_new'] =  "Enter quantity_new";
    } else {
        $quantity_new = $_POST['quantity_new'];
    }

    if (empty($_POST['rate_new'])) {
        $error['rate_new'] =  "Enter rate_new";
    } else {
        $rate_new = $_POST['rate_new'];
    }

    if (empty($_POST['unit_new'])) {
        $error['unit_new'] =  "Enter unit_new";
    } else {
        $unit_new = $_POST['unit_new'];
    }


    

    if (!empty($_POST['deli_con_new'])) {
        if($_POST['deli_con_new'] !== "NULL"){
            $r_e_m_new = "Remarks: ".$_POST['deli_con_new'];}
        $deli_con_new = $_POST['deli_con_new'];
    } else {
        $r_e_m_new ='';
        $deli_con_new = "NULL";
    }

    if (!empty($_POST['quality_new'])) {
        $quality_new = $_POST['quality_new'];
    } else {
        $quality_new = '';
    }
    
    if (!empty($_POST['dis_st_from_new'])) {
        $dis_st_from_new = $_POST['dis_st_from_new'];
    } else {
        $dis_st_from_new = '';
    }

    if (!empty($_POST['pay_con_new'])) {
        $pay_con_new = $_POST['pay_con_new'];
    } else {
        $pay_con_new = '';
    }

    


    if (!empty($_POST['s_brok_new'])) {

        $s_brok_new = $_POST['s_brok_new'];
    } else {
        $s_brok_new = 0;
    }



    if (!empty($_POST['b_brok_new'])) {

        $b_brok_new = $_POST['b_brok_new'];
    } else {
        $b_brok_new = 0;
    }





if(isset($_POST['ischecked'])){
        $dev_sql=   "SELECT `phone` FROM `ledgers` WHERE `name` = '$s_party_new' and `company`='$company_current'";
        $dev_sql1=   "SELECT `phone` FROM `ledgers` WHERE `name` = '$b_party_new' and `company`='$company_current'";

        $dev_q = mysqli_query($conn,$dev_sql);
        $dev_q1 = mysqli_query($conn,$dev_sql1);

        $r_dev = mysqli_fetch_assoc($dev_q);
        $r_dev1 = mysqli_fetch_assoc($dev_q1);

              $seller_phone = $r_dev['phone'];
              $seller_phone1 = $r_dev['phone1'];
              $buyer_phone = $r_dev1['phone'];
              $buyer_phone1 = $r_dev1['phone1'];


              if(!empty($seller_phone) && !empty($buyer_phone)){
                        


$message ='CORRECTION DETAILS:- Date:- '.date("d/m/Y", strtotime($date_new)). ' Seller Party:'.' '.$s_party_new.', Buyer Party:'.' '.$b_party_new.',  '.$goods_new.'-'.' '.$quantity_new.' '.$unit_new.' '.'@'.$rate_new .' '.$r_e_m_new;
//new
// // Configure client
// $config = Configuration::getDefaultConfiguration();
// $config->setApiKey('Authorization', 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJhZG1pbiIsImlhdCI6MTU4NzAzOTc3MCwiZXhwIjo0MTAyNDQ0ODAwLCJ1aWQiOjc5Mzg5LCJyb2xlcyI6WyJST0xFX1VTRVIiXX0.G9NNhR5BNWwPOCBrvlFd89q7u5963PcozePjdK3930s');
// $apiClient = new ApiClient($config);
// $messageClient = new MessageApi($apiClient);

       

// $sendMessageRequest1 = new SendMessageRequest([
// 'phoneNumber' => $tel_no2_company,
// 'message' => $message,
// 'deviceId' => 116747
// ]);
// $sendMessageRequest2 = new SendMessageRequest([
// 'phoneNumber' => $tel_no1_company,
// 'message' => $message,
// 'deviceId' => 116747
// ]);

// $sendMessageRequest3 = new SendMessageRequest([
// 'phoneNumber' => $seller_phone,
// 'message' => $message,
// 'deviceId' => 116747
// ]);

// $sendMessageRequest4 = new SendMessageRequest([
// 'phoneNumber' => $buyer_phone,
// 'message' => $message,
// 'deviceId' => 116747
// ]);

// $sendMessages = $messageClient->sendMessages([$sendMessageRequest1,$sendMessageRequest2,$sendMessageRequest3,$sendMessageRequest4]);

// print_r($sendMessages);

$send1 = sendsms($tel_no2_company,$message,$id);
$send2 = sendsms($tel_no1_company,$message,$id);
$send3 = sendsms($seller_phone,$message,$id);
$send4 = sendsms($buyer_phone,$message,$id);


if(!empty($seller_phone1)) 
{
$send5 = sendsms($buyer_phone1,$message,$new_id);

}else{
    $send5 = 1;

}

if(!empty($buyer_phone1)) 
{
$send6 = sendsms($seller_phone1,$message,$new_id);

}else{
    $send6 = 1;

}

// $send5 = sendwa($tel_no2_company,$message);
// $send6 = sendwa($tel_no1_company,$message);
// $send7 = sendwa($seller_phone,$message);
// $send8 = sendwa($buyer_phone,$message);

$sendMessages = [$send1,$send2,$send3,$send4,$send5,$send6];

// print_r($sendMessages);
if(!array_filter($sendMessages)){
    $error['sms'] =   "But Message Failed to Sent";
    echo "<body onload=\"M.toast({html: '{$error['sms']}'})\"></body>";
// echo  $sendMessageRequest1,$sendMessageRequest2;
}
//new end



}else{
    $error['sms']= "Message Failed, Please Add Numbers of Sender OR Buyer Party";
    echo "<body onload=\"M.toast({html: '{$error['sms']}'})\"></body>";

}
} else{
          // echo 'not checked';
          //when send sms is not checked
       } 



    if (!array_filter($error)) {
        $date_ok = date('yy-m-d', strtotime($date_new));
     

        $sql = "UPDATE `r_contract` SET `date`= '$date_ok', `seller_party` = '$s_party_new', `buyer_party`= '$b_party_new', `goods`='$goods_new', `RATE`='$rate_new', `quantity`='$quantity_new', `r_unit`='$unit_new', `del_con`='$deli_con_new', `quality`='$quality_new', `dsf`='$dis_st_from_new', `pay_con`='$pay_con_new', `sb`='$s_brok_new', `bb`='$b_brok_new', `company` ='GOYAL TRADERS' WHERE CONCAT(`r_contract`.`id`) = $id";
			

        if (!mysqli_query($conn, $sql)) {
            echo '<div class="container">' . "<h6> Error: " . $sql . "<br>" . mysqli_error($conn) . '</div>';
        } else {
            
   echo "<script>location.replace('$link');</script>";
        
            //    header($link);
            mysqli_close($conn);
        }
    }else{
        echo "<body onload=\"M.toast({html: 'Check For Errors in the form'})\"></body>";
    }
} else {
   
    //false if


}?> 


<section class="container grey-text ">


    <form class="white" style="padding: 20px;margin: 10px auto;max-width: 100%;margin-bottom:40px;" 

    action=<?php if(isset($_GET['pid'])){echo 'contract_modify.php?id='.$id.'&pid='.$_GET['pid'];}else{ echo 'contract_modify.php?id='.$id;} ?>
    
    method="POST">
        <h4 class="grey-text center">Contract Edit Fourm:</h4>
        <div class="row">
            <div class="col s6 m6 l6">
                <h6>
                    <div class="grey lighten-4 black-text">Contract ID: <?php echo $new_id ?></div>
                </h6>
            </div>
            <div class="col s6 m6 l6">
                <div class="input-field">
                    <i class="material-icons prefix">date_range</i>
                    <input type="text" id="date_new" name="date_new" class="datepicker" value="<?php echo $date ?>">
                    <div class="red-text"><?php echo htmlspecialchars($error['date-new']) ?></div>

                    <!-- <label for="date_new">Choose a date_new...</label> -->
                </div>

            </div>

        </div>

        <div class="row">
            <div class="col s6 m6 l6">
                <label>Seller Party</label>
                <select class="initialized" type="text" name="s_party_new" value="<?php echo $s_party ?>">
                    <option value="" disabled selected> ...Select Seller Party... </option>
                    <?php if (mysqli_num_rows($result_g) > 0) {
                        // output data of each row
                        while ($rowg = mysqli_fetch_assoc($result_g)) { ?>

                            <option <?php if($rowg['name']==$s_party){echo 'selected';} ?>><?php echo $rowg['name']; ?></option>
                    <?php }
                    } else {
                        echo 'no Seller Party';
                    } ?> ?>
                </select>
                <div class="red-text"><?php echo htmlspecialchars($error['s_party_new']) ?></div>

            </div>


            <div class="col s6 m6 l6">


                <label>Buyer Party</label>
                <select class="initialized" type="text" name="b_party_new" value="<?php echo $b_party ?>">
                    <option value="" disabled selected> ...Select Buyer Party... </option>
                    <?php if (mysqli_num_rows($result_g1) > 0) {
                        // output data of each row
                        while ($rowg1 = mysqli_fetch_assoc($result_g1)) { ?>

                            <option <?php if($rowg1['name']==$b_party){echo 'selected';} ?>  ><?php echo $rowg1['name']; ?></option>
                    <?php }
                    } else {
                        echo 'no Buyer Party';
                    } ?> ?>
                </select>
                <div class="red-text"><?php echo htmlspecialchars($error['b_party_new']) ?></div>

            </div>
        </div>




        <div class="row">
            <div class="col s6 m6 l3">

                <label>Goods:</label>
                <select class="initialized" type="text" name="goods_new" value="<?php echo $goods ?>">
                    <option value="" disabled selected> ...Select Goods... </option>
                    <?php if (mysqli_num_rows($result1234) > 0) {
                        // output data of each row
                        while ($rowg1234 = mysqli_fetch_assoc($result1234)) { ?>

                            <option <?php if($rowg1234['name']==$goods){echo 'selected';} ?>><?php echo $rowg1234['name']; ?></option>
                    <?php }
                    } else {
                        echo 'no goods';
                    } ?>
                </select>
                <div class="red-text"><?php echo htmlspecialchars($error['goods_new']) ?></div>

            </div>

            <div class="col s6 m6 l3">
                <label>Quantity:</label>
                <input type="text" name="quantity_new" value="<?php echo $quantity ?>">
                <div class="red-text"><?php echo htmlspecialchars($error['quantity_new']) ?></div>
            </div>
            <div class="col s6 m6 l2">
                <label>Unit:</label>
                <select name="unit_new" value="<?php echo htmlspecialchars($unit) ?>">
                    <option <?php if($unit=='MT'){echo 'selected';} ?> >MT</option>
                    <option <?php if($unit=='BAGS'){echo 'selected';} ?> >BAGS</option>
                    <option <?php if($unit=='TIN'){echo 'selected';} ?> >TIN</option>

                </select>
                <div class="red-text"><?php echo htmlspecialchars($error['unit_new']) ?></div>
            </div>

            <div class="col s6 m6 l4" style="margin-top:2px;">
                <label>Rate:</label>
                <input type="text"  id="rate_new" name="rate_new" value="<?php echo $rate ?>">
                <div class="red-text"><?php echo $error['rate_new'] ?></div>

            </div>
        </div>


        <div class="row">
            <div class="col s6 m6 l4">
                <label>Delivery Condition:</label>
                <input type="text" id="deli_con_new" name="deli_con_new" class="" value="<?php echo $deli_con ?>">
            </div>
            <div class="col s6 m6 l4">
                <label>Quality:</label>
                <input type="text" id="quality_new" name="quality_new" class="" value="<?php echo $quality ?>">
            </div>
            <div class="col s6 m6 l4">
                <label>Dispatch Station From:</label>
                <input type="text" id="dis_st_from_new" name="dis_st_from_new" class="" value="<?php echo $dis_st_from ?>">
            </div>
        </div>

        <div class="row">
            <div class="col s6 m6 l4">
                <label>Payment Condition:</label>
                <input type="text" id="pay_con_new" name="pay_con_new" class="" value="<?php echo $pay_con ?>">
            </div>
            <div class="col s6 m6 l4">
                <label>Seller Brokerage:</label>
                <input type="number" step="any" id="s_brok_new" name="s_brok_new" class="" value="<?php echo $s_brok ?>">
            </div>
            <div class="col s6 m6 l4">
                <label>Buyer Brokerage:</label>
                <input type="number" id="b_brok_new" step="any" name="b_brok_new" class="" value="<?php echo $b_brok ?>">
            </div>
        </div>















        <div class="left">
        <label>
                                    <input type="checkbox" name="ischecked" class="filled-in" value="checked" >

                                    <span style="margin-right: 10px;">Send SMS</span>
                                </label>
            <input type="submit" name="submit" value="submit" class="btn center white-text brand-btn">
            <a href="contract_view.php" class="btn">cancel</a>
        </div>
        <a href="contract_delete.php?id=<?php echo $id ?>" class="waves-effect btn">Delete This Contract</a>
    </form>


</section>
<?php }
else{
    echo '<h5 class="container">'.'Please Check url'.'</h5>' ;
}
?>

<?php include('footer.php'); ?>