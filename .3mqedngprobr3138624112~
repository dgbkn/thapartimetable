<?php
   include('session.php');
?>




<?php 
include('conn.php'); 
$page_title='View Ledger';
?>

<?php include('header.php'); ?>

<div class="row">

    <div class="l8 left wrap_table__" style="background-color: white;" id="tab">
     
            <table class="highlight okok"><tr>
                <th>
                    ID
                </th>
                <th>
                    Date
                </th>
                <th>
                    Seller
                </th>
                <th>
                    Buyer
                </th>
                <th>
                    Goods
                </th>
                <th>
                    Rate
                </th>
                <th>
                    Quantity
                </th>
                <th class="brokerage changeme hide-on-print">
                    Seller Brokerage
                </th>
                <th class="brokerage changeme hide-on-print">
                    Buyer Brokerage
                </th>
                <th>
                    Delivery Condition
                </th>
                <th>
                    Quality
                </th>
                <th>
                    Dispatch Station From
                </th>
                <th>
                    Payment Condition
                </th>
                
                
                  <?php
                  global $sql_v;
                
                  if(isset($_GET['party_name'])){
                    if(isset($_POST['submit_date'])){
                        $start_date = $_POST['datefrom'];
                        $end_date = $_POST['dateto'];
                     
                        $sql_v ="SELECT * FROM `r_contract` WHERE `seller_party` = '{$_GET['party_name']}' AND `date` BETWEEN '$start_date' AND '$end_date' UNION SELECT * FROM `r_contract` WHERE `buyer_party` = '{$_GET['party_name']}' AND `date` BETWEEN '$start_date' AND '$end_date'  AND `compnay`= $company_current ORDER BY `id` DESC";
                    
                    }
                    elseif(isset($_POST['see_all'])){
                        $sql_v = "SELECT * FROM `r_contract` WHERE `seller_party` = '{$_GET['party_name']}' UNION SELECT * FROM `r_contract` WHERE `buyer_party` = '{$_GET['party_name']}' AND `compnay`= $company_current  ORDER BY `id` DESC";
                    }
                    else{
                        $sql_v = "SELECT * FROM `r_contract` WHERE `seller_party` = '{$_GET['party_name']}' UNION SELECT * FROM `r_contract` WHERE `buyer_party` = '{$_GET['party_name']}' AND `compnay`= $company_current ORDER BY `id` DESC";
                    }
                  }
                  else{
                    if(isset($_POST['submit_date'])){
                        $start_date = $_POST['datefrom'];
                        $end_date = $_POST['dateto'];
                        $sql_v = "SELECT * FROM `r_contract` WHERE `date` BETWEEN '$start_date' AND '$end_date' and `company`= '$company_current' ";
                        

                    }
                    elseif(isset($_POST['see_all'])){
                       
                        $sql_v = "SELECT * FROM `r_contract` WHERE `company`= '$company_current' ORDER BY `id` DESC   ";
                    }
                    else{
                       
                        $sql_v = "SELECT * FROM `r_contract` WHERE `company`= '$company_current' ORDER BY `id` DESC  limit 50";

                    }
                }
                    $query_v = mysqli_query($conn,$sql_v);
                    // print_r(mysqli_fetch_assoc($query_v));
                    while($result_v = mysqli_fetch_assoc($query_v)):
                  ?><?php 
                  $orgDate = $result_v['date'];
                  $newDate = date("d/m/Y", strtotime($orgDate));
                  ?>
                  
                  <tr class='clickable-row' data-href='contract_modify.php?id=<?php echo $result_v['id']; ?>'>
                  
                      <td>
                          <a href='contract_modify.php?id=<?php echo $result_v['id']; ?>'>
                          <?php echo $result_v['id']; ?></a>
                      </td>
                      <td>
                          <?php echo $newDate; ?>
                      </td>
                      <td>
                          <?php echo $result_v['seller_party']; ?>
                      </td>
                      <td>
                          <?php echo $result_v['buyer_party']; ?>
                      </td>
                      <td>
                          <?php echo $result_v['goods']; ?>
                      </td>
                      <td>
                          <?php echo $result_v['RATE']; ?>
                      </td>
                      <td>
                          <?php echo $result_v['quantity']; ?><?php echo ' ';?><?php echo $result_v['r_unit']; ?>
                      </td>
                      <td class="brokerage changeme hide-on-print">
                          <?php echo $result_v['sb']; ?>   
                      </td>
                      <td class="brokerage changeme hide-on-print">
                          <?php echo $result_v['bb']; ?>
                      </td>
                      <td>
                          <?php echo $result_v['del_con']; ?>
                      </td>
                      <td>
                          <?php echo $result_v['quality']; ?>
                      </td>

                      <td>
                          <?php echo $result_v['dsf']; ?>
                      </td>

                      <td>
                          <?php echo $result_v['pay_con']; ?>
                      </td>
                     
                      </tr>
                    


                    <?php endwhile; ?>
              
            
         
            <tr><td colspan="6"></td>
               <br> <td><h6>Total:</h6></td>
                   
                   <?php 
               if(isset($_POST['submit_date'])){
                $sum_sql_sb = "SELECT SUM(`sb`) AS sumsb FROM `r_contract` WHERE `date` BETWEEN '$start_date' AND '$end_date' and `company`= '$company_current'";
                $sum_sql_bb = "SELECT SUM(`bb`) AS sumbb FROM `r_contract` WHERE `date` BETWEEN '$start_date' AND '$end_date' and `company`= '$company_current'";
                
               }
               else{
                $sum_sql_sb = "SELECT SUM(`sb`) AS sumsb FROM `r_contract` WHERE `company`= '$company_current'";
                $sum_sql_bb = "SELECT SUM(`bb`) AS sumbb FROM `r_contract` WHERE `company`= '$company_current'";
               }

                $query_s_sb = mysqli_query($conn,$sum_sql_sb);
                $result_s_sb = mysqli_fetch_assoc($query_s_sb);

                $query_s_bb = mysqli_query($conn,$sum_sql_bb);
                $result_s_bb = mysqli_fetch_assoc($query_s_bb);
                // print_r($result);
               ?>
                   
           <td><h6> <?php echo $result_s_sb['sumsb'] ?></h6> </td>
          <td> <h6> <?php echo $result_s_bb['sumbb'] ?> </h6></td>
          <td colspan="2"></td>
            </tr>
            </table>          
    </div>

    <div class="l4 right">

<form action="<?php
 if(isset($_GET['party_name']))
 {echo "contract_view.php?party_name={$_GET['party_name']}";}
 else{echo 'contract_view.php';}
 
 ?>" class="white" style="padding:20px;width:200px;margin-right:120px;margin-top:5px;" methord="POST">
<h6 class="center">Pick Dates:</h6>
<label for="datefrom" class="center"> From..</label>   

<input type="date" class="date" id="datefrom" name="datefrom" value="<?php echo $start_date?>">

<label for="dateto" class="center" > To..</label>   
<input type="date" class="date" id="dateto" name="dateto" value="<?php echo $end_date?>">
<input type="submit"  formmethod="post" formaction="<?php
 if(isset($_GET['party_name']))
 {echo "contract_view.php?party_name={$_GET['party_name']}";}
 else{echo 'contract_view.php';}
 
 ?>" name="submit_date" class="btn" value="submit_date">
<h6 class="center">OR:</h6>

<input type="submit"  formmethod="post" formaction="<?php
 if(isset($_GET['party_name']))
 {echo "contract_view.php?party_name={$_GET['party_name']}";}
 else{echo 'contract_view.php';}
 
 ?>" name="see_all" class="btn" value="see_all">




</form>
<input type="button" value="Create PDF" class="btn center"
style="margin-left:20px;margin-top:10px;"
            id="btPrint" onclick="createPDF()" />
            <br>
            <br>
                 <label>
        <input type="checkbox" class="filled-in" id="test" />
        <span>Check To Enable Brokoerage<br> in Printing</span>
      </label>
    </div>
</div>
<script>
    function createPDF() {
        var sTable = document.getElementById('tab').innerHTML;
       
        var style = "<style>";
        style = style + "td,th{padding: 5px 2px;border-width:4px;border-right-width: 4px;border-left-width:4px; border-color: black;display: table-cell;text-align: left;vertical-align: left; white-space: nowrap; font-size: 14px;font-weight: 600;}";
        style = style + "table {width: 100%;font: 17px Calibri;}";
        style = style + "table, th, td {border: solid 1px #DDD; border-collapse: collapse;";
        style = style + "padding: 2px 3px;text-align: left;}";
        style = style + ".hide-on-print{display:none!important;}"
        style = style + ".super-head{font-size:45px;font-family:sans-serif;font-weight:700;text-align:center;margin-bottom:-18px;text-transform:uppercase;}"
        style = style + "</style>";
        // CREATE A WINDOW OBJECT.
        var win = window.open('', '', 'height=700,width=1200');

        win.document.write('<html><head>');
        win.document.write('<title>Print Detailed</title>');   // <title> FOR PDF HEADER.
        win.document.write(style);          // ADD STYLE INSIDE THE HEAD TAG.
        win.document.write('</head>');
        win.document.write('<body>');
        win.document.write('<center><table><tr><td>G.S.T. NO. - <?php echo $gst_company; ?><br>PAN NO. -   <?php echo $pan_no_company; ?></td><td><div class="super-head"><?PHP echo $company_current; ?></div></td><div><br><?php echo $about_remark_company; ?><br><?php echo $addres1_company; ?><br><?php echo $addres2_company; ?></div><center></tr></table>');
        win.document.write(sTable);         // THE TABLE CONTENTS INSIDE THE BODY TAG.
        win.document.write('</body></html>');

        win.document.close(); 	// CLOSE THE CURRENT WINDOW.

        win.print();    // PRINT THE CONTENTS.
    }
</script>





<?php include('footer.php') ?>


<script>
    $('#test').change(function(){
    if($(this).is(":checked")) {
       
        $('.changeme').removeClass('hide-on-print');
    } else {
         $('.changeme').addClass('hide-on-print');
    }
});
</script>