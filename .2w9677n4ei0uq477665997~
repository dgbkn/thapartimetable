<?php
include('session.php');
?>




<?php
include('conn.php');
$page_title = 'Brokerage Recived';

?>

<?php include('header.php'); ?>

<?php

if (isset($_POST['submit'])) {
    // echo $_POST['submit'];

    $sql_ractify = "UPDATE `ledgers` SET `brok_rec_flag` = '0' WHERE `ledgers`.`id` = {$_POST['submit']}";
    $query_ractify = mysqli_query($conn, $sql_ractify);
    if ($query_ractify) {
        //do nothingg
    } else {
        echo 'error';
    }
}



?>

<div class="l8 left wrap_table__" style="background-color: white;" id="tab">
    <div>
        <table class="highlight okok">
            <tr>

                <th>
                    NAME
                </th>
                <th>
                    DEBIT
                </th>


                <th>
                    Brokerage Recived
                </th>
                <th class="hide-on-print">
                    Ractify Entery
                </th>
            </tr>

            <?php
            $sql = "SELECT `id`,`name`, `print_flag`,`brok_rec_flag`,`brok_rec` from `ledgers` where `company` = '$company_current' and `brok_rec_flag` = 1  order by `name` asc ";
            $result = mysqli_query($conn, $sql);
            if (mysqli_num_rows($result) > 0) {
                $total = 0;
                $total_b = 0;
                while ($rows = mysqli_fetch_assoc($result)) :

                    $sum_sql_sb = "SELECT SUM(`sb`) AS sumsb FROM `r_contract` WHERE `seller_party` = '{$rows['name']}'";

                    $query_s_sb = mysqli_query($conn, $sum_sql_sb);
                    $result_s_sb = mysqli_fetch_assoc($query_s_sb);

                    $sum_sql_bb = "SELECT SUM(`bb`) AS sumbb FROM `r_contract` WHERE `buyer_party` = '{$rows['name']}'";
                    $query_s_bb = mysqli_query($conn, $sum_sql_bb);
                    $result_s_bb = mysqli_fetch_assoc($query_s_bb);
                    // print_r($result);
                    $sum_brokerage = $result_s_sb['sumsb'] + $result_s_bb['sumbb'];

            ?>
                    <tr <?php if ($sum_brokerage === 0) {
                            echo 'class="hiddenn hide-on-print"';
                        }  ?>>
                        <!-- do some loop -->



                        <td><?php echo $rows['name'] ?></td>
                        <td>
                            <?php echo $sum_brokerage; ?>
                        </td>
                        <td>
                            <?php echo $rows['brok_rec'] ?>
                        </td>

                        <td class="hide-on-print">
                            <form action="brok_rec.php" methord="POST">
                                <label>
                                    <input type="checkbox" name="ischecked" class="filled-in" onchange="document.getElementById('submit__id<?php echo $rows['id']; ?>').click();">

                                    <span></span>
                                </label>
                                <input type="submit" name="submit" id="submit__id<?php echo $rows['id']; ?>" class="hiddenn hide-on-print" formmethod="post" formaction="brok_rec.php" value="<?php echo $rows['id']; ?>">
                            </form>

                        </td>
                    </tr>
                    <?php $total = $total + $sum_brokerage ;
                    $total_b = $total_b + $rows['brok_rec'];
                     ?>
            <?php endwhile;
            } else {
                echo '0 records';
            } ?>
            <tr>
                <?php
                // $sum_sql_sb = "SELECT SUM(`sb`) AS sumsb FROM `r_contract` where `company` = '$company_current'";

                // $query_s_sb = mysqli_query($conn, $sum_sql_sb);
                // $result_s_sb = mysqli_fetch_assoc($query_s_sb);

                // $sum_sql_bb = "SELECT SUM(`bb`) AS sumbb FROM `r_contract` where `company` = '$company_current'";
                // $query_s_bb = mysqli_query($conn, $sum_sql_bb);
                // $result_s_bb = mysqli_fetch_assoc($query_s_bb);
                // // print_r($result);
                // $sum_brokerage = $result_s_sb['sumsb'] + $result_s_bb['sumbb'];

                // $sql_bbrec = "SELECT SUM(`brok_rec`) AS bbrec from `ledgers` where `company` = '$company_current' and `brok_rec_flag` = 1  order by `name` asc ";
                // $result_bbrec = mysqli_query($conn, $sql_bbrec);
                // $res_bbrec = mysqli_fetch_assoc($result_bbrec);
                // $sum_bbrec = $res_bbrec['bbrec'];

                ?>



            </tr>
            <td class="right">Total:</td>
            <td> <?php echo $total; ?></td>
            <td><?php echo $total_b ?></td>
            </tr>
        </table>
    </div>
</div>
<input type="button" value="Create PDF" class="btn center" style="margin-left:20px;margin-top:10px;" id="btPrint" onclick="createPDF()" />
<script>
        function createPDF() {
            var sTable = document.getElementById('tab').innerHTML;

            var style = "<style>";
            style = style + "td.brokerage{text-align:right!important;}"
            // style = style + "@page { size: auto;  margin: 0mm; }"
            style = style + "td,th{padding: 5px 2px;border-width:4px;border-right-width: 4px;border-left-width:4px; border-color: black;display: table-cell;text-align: left;vertical-align: left; white-space: nowrap; font-size: 14px;font-weight: 600;}";
            style = style + "table.okok {width:80%;margin-left:80px;font: 17px Calibri;}";
            style = style + "table.okok,table.okok> tbody > th, table.okok> tbody >tr>td,table.okok> tbody > tr>th {border: solid 1px #DDD; border-collapse: collapse;";
            style = style + "padding: 2px 3px;text-align: left;}";
            style = style + ".hide-on-print{display:none!important;}"
            style = style + ".super-head{font-size:30px;font-family:'Gungsuh';font-weight:700;text-transform:uppercase;margin-bottom:-18px;}"
            style = style + "table#custom.custom >tbody >tr {border: 0px!important;}";
            style = style + "table#custom.custom >tbody >tr >td {border: 0px!important;}";
            style = style + "</style>";
            // CREATE A WINDOW OBJECT.
            var win = window.open('', '', 'height=700,width=1200');           


            win.document.write('<html><head>');
            win.document.write('<title><?php echo $rowis['name']; ?></title>'); // <title> FOR PDF HEADER.
            win.document.write(style); // ADD STYLE INSIDE THE HEAD TAG.
            win.document.write('</head>');
            win.document.write('<body>');
            win.document.write('<center><table class="custom" id="custom"><tr> <td> <center><div class="super-head"><?PHP echo $company_current; ?></div> <br><?php echo $about_remark_company; ?><br><?php echo $addres1_company; ?><br><?php echo $addres2_company; ?><br><br><B><u>BROKERAGE STATEMENT  @ RECIVED</u></B></div></center></td><td style="width:14%"></td></tr> </table></center>');
            win.document.write(sTable);
            win.document.write('</body></html>');
            win.document.close(); // CLOSE THE CURRENT WINDOW.
            win.document.title = "Print Detailed";


            win.print(); // PRINT THE CONTENTS.
        }
    </script>

<?php include('footer.php') ?>